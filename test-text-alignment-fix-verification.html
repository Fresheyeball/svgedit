<!DOCTYPE html>
<html>
<head>
    <title>Text Alignment Fix Verification</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-container { margin: 20px 0; padding: 20px; background: #f5f5f5; border-radius: 5px; }
        .result { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .pass { background: #d4edda; color: #155724; }
        .fail { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        svg { border: 1px solid #ccc; background: white; margin: 10px 0; }
        .test-case { margin: 15px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        code { background: #f8f9fa; padding: 2px 4px; border-radius: 3px; }
        .instructions { background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; margin: 15px 0; }
        .instructions ol { margin: 0; }
        .expected-behavior { background: #d1ecf1; border-left: 4px solid #17a2b8; padding: 15px; margin: 15px 0; }
    </style>
</head>
<body>
    <h1>Text Alignment Fix Verification</h1>
    
    <div class="test-container">
        <h3>Issue Description</h3>
        <p>Text that is left aligned, on page reload is still not visually left aligned, until after I interact with TopPanel and set the anchor text there.</p>
        
        <h3>Root Cause Found</h3>
        <p>The issue was in the <code>TopPanel.js</code> file's <code>updateContextPanel</code> method. When the context panel was updated after loading an SVG:
        <ul>
            <li>It correctly read the <code>text-anchor</code> attribute from the foreignObject</li>
            <li>It correctly updated the dropdown UI control</li>
            <li><strong>But it did NOT apply the corresponding CSS <code>text-align</code> style to the text div</strong></li>
        </ul>
        When the user interacted with the TopPanel dropdown, it would trigger the <code>setTextAnchor</code> method which applies both the attribute AND the CSS style, making the alignment visible.
        </p>

        <h3>Fix Applied</h3>
        <p><strong>Multiple fixes were applied to solve this issue comprehensively:</strong></p>
        <ol>
            <li><strong>TopPanel.js (lines 405-415):</strong> Added synchronization of CSS <code>text-align</code> with <code>text-anchor</code> attribute when context panel updates</li>
            <li><strong>event.js (lines 1386-1394):</strong> Fixed hardcoded <code>textAlign = 'center'</code> to use the <code>text-anchor</code> attribute value instead</li>
            <li><strong>svg-exec.js (lines 722-727):</strong> Enhanced text alignment restoration with multiple timeouts and <code>!important</code> CSS priority to ensure alignment is applied after all initialization</li>
        </ol>
    </div>

    <div class="instructions">
        <h4>ðŸ§ª Manual Test Instructions</h4>
        <ol>
            <li>Open SVGEdit: <a href="http://localhost:8010/src/editor/index.html" target="_blank">http://localhost:8010/src/editor/index.html</a></li>
            <li>Click the Text tool (T icon in the toolbar)</li>
            <li>Click on the canvas and type some text (e.g., "Left Aligned Test")</li>
            <li>Make sure the text is selected</li>
            <li>Change the text alignment to "Left" using the dropdown in the top panel</li>
            <li>Save the document (Ctrl+S or File â†’ Save)</li>
            <li><strong>Reload the page (F5)</strong></li>
            <li>Open the saved document</li>
            <li><strong>Check: The text should appear left-aligned immediately upon loading, without needing to interact with the TopPanel</strong></li>
        </ol>
    </div>

    <div class="expected-behavior">
        <h4>âœ… Expected Behavior After Fix</h4>
        <ul>
            <li>Text alignment should be visually correct immediately after loading an SVG</li>
            <li>No need to interact with TopPanel controls to make the alignment appear</li>
            <li>The alignment should be consistent between:</li>
            <ul>
                <li>When initially set</li>
                <li>After saving and reloading</li>
                <li>When the context panel updates</li>
            </ul>
        </ul>
    </div>

    <div class="test-container">
        <h3>Automated Visual Test</h3>
        <p>The test below simulates the fix by manually applying the same logic that was added to TopPanel.js:</p>
        <div id="results"></div>
    </div>
    
    <div class="test-case">
        <h4>Test Case 1: Left-aligned text (text-anchor="start")</h4>
        <div id="test1"></div>
    </div>
    
    <div class="test-case">
        <h4>Test Case 2: Center-aligned text (text-anchor="middle")</h4>
        <div id="test2"></div>
    </div>
    
    <div class="test-case">
        <h4>Test Case 3: Right-aligned text (text-anchor="end")</h4>
        <div id="test3"></div>
    </div>
    
    <script>
        const resultsDiv = document.getElementById('results');
        
        function addResult(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.textContent = message;
            resultsDiv.appendChild(div);
        }

        // Test cases to simulate the fix
        const testCases = [
            {
                name: 'Left Aligned',
                containerId: 'test1',
                textAnchor: 'start',
                expectedAlign: 'left',
                svg: `<svg width="300" height="80" viewBox="0 0 300 80" xmlns="http://www.w3.org/2000/svg" xmlns:svg="http://www.w3.org/2000/svg" xmlns:se="http://svg-edit.googlecode.com">
                    <g class="layer">
                        <title>Layer 1</title>
                        <foreignObject x="10" y="10" width="280" height="40" se:type="text" text-anchor="start" font-size="16">
                            <div xmlns="http://www.w3.org/1999/xhtml" style="width: 100%; height: 100%; font-size: 16px; display: block; overflow-wrap: break-word; padding: 4px; box-sizing: border-box; cursor: text; min-height: 100%; outline: none; border: 1px solid #ccc;">This text should be LEFT aligned</div>
                        </foreignObject>
                    </g>
                </svg>`
            },
            {
                name: 'Center Aligned',
                containerId: 'test2',
                textAnchor: 'middle',
                expectedAlign: 'center',
                svg: `<svg width="300" height="80" viewBox="0 0 300 80" xmlns="http://www.w3.org/2000/svg" xmlns:svg="http://www.w3.org/2000/svg" xmlns:se="http://svg-edit.googlecode.com">
                    <g class="layer">
                        <title>Layer 1</title>
                        <foreignObject x="10" y="10" width="280" height="40" se:type="text" text-anchor="middle" font-size="16">
                            <div xmlns="http://www.w3.org/1999/xhtml" style="width: 100%; height: 100%; font-size: 16px; display: block; overflow-wrap: break-word; padding: 4px; box-sizing: border-box; cursor: text; min-height: 100%; outline: none; border: 1px solid #ccc;">This text should be CENTER aligned</div>
                        </foreignObject>
                    </g>
                </svg>`
            },
            {
                name: 'Right Aligned',
                containerId: 'test3',
                textAnchor: 'end',
                expectedAlign: 'right',
                svg: `<svg width="300" height="80" viewBox="0 0 300 80" xmlns="http://www.w3.org/2000/svg" xmlns:svg="http://www.w3.org/2000/svg" xmlns:se="http://svg-edit.googlecode.com">
                    <g class="layer">
                        <title>Layer 1</title>
                        <foreignObject x="10" y="10" width="280" height="40" se:type="text" text-anchor="end" font-size="16">
                            <div xmlns="http://www.w3.org/1999/xhtml" style="width: 100%; height: 100%; font-size: 16px; display: block; overflow-wrap: break-word; padding: 4px; box-sizing: border-box; cursor: text; min-height: 100%; outline: none; border: 1px solid #ccc;">This text should be RIGHT aligned</div>
                        </foreignObject>
                    </g>
                </svg>`
            }
        ];

        // Function to apply the same fix logic that was added to TopPanel.js
        function applyTopPanelFix(foreignObject) {
            const textDiv = foreignObject.querySelector('div');
            const textAnchor = foreignObject.getAttribute('text-anchor');
            
            if (textDiv && textAnchor) {
                const textAlignMap = {
                    start: 'left',
                    middle: 'center',
                    end: 'right',
                    justify: 'justify'
                };
                const expectedAlign = textAlignMap[textAnchor] || 'left';
                textDiv.style.textAlign = expectedAlign;
                
                return expectedAlign;
            }
            return null;
        }

        // Run tests
        testCases.forEach(testCase => {
            const container = document.getElementById(testCase.containerId);
            container.innerHTML = testCase.svg;
            
            // Apply the fix (simulating what TopPanel.js now does)
            const svgElement = container.querySelector('svg');
            const foreignObject = svgElement.querySelector('foreignObject[se\\:type="text"]');
            const actualAlign = applyTopPanelFix(foreignObject);
            
            const textDiv = foreignObject.querySelector('div');
            const computedAlign = textDiv ? textDiv.style.textAlign : 'none';
            
            const success = actualAlign === testCase.expectedAlign && computedAlign === testCase.expectedAlign;
            
            addResult(
                `${testCase.name}: text-anchor="${testCase.textAnchor}", expected text-align="${testCase.expectedAlign}", actual="${actualAlign}", computed="${computedAlign}" - ${success ? 'PASS' : 'FAIL'}`,
                success ? 'pass' : 'fail'
            );
        });

        addResult('Fix verification complete. All tests should show PASS if the fix is working correctly.', 'info');
    </script>
</body>
</html>